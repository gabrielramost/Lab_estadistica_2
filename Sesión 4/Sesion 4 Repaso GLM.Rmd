---
title: "Sesión 4. Modelos Lineales Generalizados"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

### A. Regresión Poisson (No lineal)

La regresión Poisson tiene sus supuestos:

+ Variable de respuesta es un conteo por unidad de tiempo o espacio, que puede ser descrita por la distribución Poisson.

+ Independencia: Las observaciones (filas) no deben tener relación entre sí.

+ Media=Varianza: Por definición, la media de una variable que se distribuye como Poisson debe ser igual a su varianza.

+ Linealidad: El logaritmo de la media de los datos, log(λ), debe ser una función lineal de los datos


```{r}
library(rio)
data=import("https://github.com/gabrielramost/Lab_estadistica_2/blob/main/Sesi%C3%B3n%204/IOP_1119_01_02_D.sav?raw=true")
data=subset(data, SERIE== 2019)
```

Variable dependiente:

Voy a construir un indice que será mi variable dependiente, recuerde que para este tipo de regresión debe ser una variable de conteo

Se pregunto si había sido víctima de los siguientes actos de acoso callejero:
• Fue objeto de miradas persistentes e incómodas
• Recibió silbidos
• Le hicieron ruidos de besos
• Le hicieron gestos vulgares
• Recibió comentarios e insinuaciones de tipo sexual
• Fue manoseado/a sin su consentimiento
• Fue blanco de exhibicionismo (mostrar partes íntimas del cuerpo)
• Fue blanco de roces incómodos y frotamientos en transporte público y/o espacios congestionados (masturbación pública)

```{r}
#Codificación
data$P12A[data$P12A == "2"] <- 0
data$P12B[data$P12B == "2"] <- 0
data$P12C[data$P12C == "2"] <- 0
data$P12D[data$P12D == "2"] <- 0
data$P12E[data$P12E == "2"] <- 0
data$P12F[data$P12F == "2"] <- 0
data$P12G[data$P12G == "2"] <- 0
data$P12H[data$P12H == "2"] <- 0
data$P12A[data$P12A == "98"] <- NA
data$P12B[data$P12B == "98"] <- NA
data$P12C[data$P12C == "98"] <- NA
data$P12D[data$P12D == "98"] <- NA
data$P12E[data$P12E == "98"] <- NA
data$P12G[data$P12G == "98"] <- NA
data$P12H[data$P12H == "98"] <- NA
# Creación del indice
data$indiceAC=data$P12A+data$P12B+data$P12C+data$P12D+data$P12E+data$P12F+data$P12G+data$P12H
```

Visualizo:

```{r}
table(data$indiceAC)
hist(data$indiceAC)
```

Variables independientes

```{r}
data$SEXO=as.factor(data$SEXO)
data$SEXO=factor(data$SEXO,levels=levels(data$SEXO) ,labels=c("Hombre","Mujer"))

data$NIVEDU=as.factor(data$NIVEDU)
data$NIVEDU=factor(data$NIVEDU,levels=levels(data$NIVEDU) ,labels=c("Ninguna","Inicial","Primaria"
,"SecundariaIncompleta","SecundariaCompleta",
"SuperiorTecnicaincompleta",
"Superiortecnica completa","Superior universitaria incompleta"
,"Superior universitaria completa","Postgrado"))

data$NSEGRUP=as.factor(data$NSEGRUP)
data$NSEGRUP=factor(data$NSEGRUP,levels=levels(data$NSEGRUP) ,labels=c("AB","C","DE"))

data$EDAD = as.numeric(data$EDAD)
```

### Cálculo de modelos

**Modelo 1**

```{r}
library(stargazer)
modelo1<-glm(indiceAC~EDAD,
             family=poisson,
             data=data)

stargazer(modelo1,type = "text",intercept.bottom = FALSE,style="all2")
```

El impacto de la variable EDAD es negativo y estadísticamente significativo sobre la probabilidad de ser víctima de acoso callejero. Pero el coeficiente no puede interpretarse de forma directa. Calculamos exponencial:

```{r}
edad=coef(modelo1)[['EDAD']] #Guardamos el coeficiente
E_Edad=exp(edad) #Le sacamos la exponencial
(CambioEdad=100*(1-1/E_Edad)) #Al ser negativo, se le saca 1-1/exp(B)
```

Interpretación: 

Al aumentar en un año de edad, el número de eventos de acoso callejero va a disminuir en 0.032 veces. O dicho de otra forma, cuando una persona incrementa en un año su edad, el número de eventos de acoso callejero va a disminuir en 3.32%

Nótese que esta regresión propone un efecto multiplicativo sobre el valor medio de la respuesta (la regresión Gaussiana propone un efecto aditivo). 



**Modelo 2**

```{r}
modelo2<-glm(indiceAC~SEXO,
             family=poisson,
             data=data)

stargazer(modelo2,type = "text",intercept.bottom = FALSE,style="all2") #categoria de referencia Hombre
```

Calculamos exponencial

```{r}
mujer=coef(modelo2)[['SEXOMujer']]
E_mujer=exp(mujer)
(CambioMujer=100*(E_mujer))
```

Interpretación: 

Si una persona es mujer, el número de eventos de acoso callejero va a aumentar en 3.7 veces. Cuando una persona es mujer, el número de eventos de acoso callejero va a aumentar en 376%.


**Comparación de modelos**

```{r}
stargazer(modelo1,modelo2, type ="text")
```

+ Se puede comparar el LOG lIKELIHOOD, el mayor será el mejor, o el modelo que tenga menor akaike.

+ Tambien podemos comparar en función de las residual deviances, haciendo un anova. Nos quedamos con el segundo.

```{r}
anova(modelo1,modelo2, test = "Chisq")
```

```{r}
library(ggplot2)
dotwhisker::dwplot(list(Poisson1=modelo1,Poisson2=modelo2),exp=T)  +
  scale_color_discrete(name="Modelos para: Acoso callejero") +
  geom_vline(xintercept = 1,
           colour = "grey60",
           linetype = 2)
```



### ¿Qué pasa cuando hay Sobredispersión? 

Uno de los supuestos era que la media y la varianza sean iguales. Si la varianza es mayor que la media, hablamos de sobredispersión (subdispersion si es menor que la media). Veamos:

```{r}
overdispersion=AER::dispersiontest(modelo1,alternative='greater')$ p.value<0.05
underdispersion=AER::dispersiontest(modelo1,alternative='less')$ p.value<0.05

# tabla
testResult=as.data.frame(rbind(overdispersion,underdispersion))
names(testResult)='Es probable?'
testResult
```

```{r}
VarY=data$indiceAC #Variable dependiente
list(media=mean(VarY,na.rm=T),varianza=var(VarY,na.rm=T),razon=var(VarY,na.rm=T)/mean(VarY,na.rm=T))
```


Veamos de solucionarlo:

**Quaipoisson**

```{r}
reg1quasi = glm(indiceAC~EDAD, family = quasipoisson, data = data)
stargazer(reg1quasi,type = "text",intercept.bottom = FALSE,style="all2")
```

Comparamos cuál es el mejor modelo:

```{r}
anova(modelo1,reg1quasi, test = "Chisq")
```

```{r}
dotwhisker::dwplot(list(Poisson1=modelo1,QuasiPoisson=reg1quasi),exp=T)  +
  scale_color_discrete(name="Modelos para: Acoso callejero") +
  geom_vline(xintercept = 1,
           colour = "grey60",
           linetype = 2)
```


**Binomial negativa**

```{r}
library(MASS)
nb <- glm.nb(indiceAC~EDAD, data = data)
stargazer(nb,type = "text",intercept.bottom = FALSE,style="all2")
```

Vemos que la binomial negativa responde mejor y corrige los errores:

```{r}
anova(modelo1,reg1quasi,nb, test = "Chisq")
```

```{r}
library(ggplot2)
dotwhisker::dwplot(list(Poisson1=modelo1,QuasiPoisson=reg1quasi,NegativeBinomial=nb),exp=T)  +
  scale_color_discrete(name="Modelos para: Acoso callejero") +
  geom_vline(xintercept = 1,
           colour = "grey60",
           linetype = 2)
```


### B. Regresión Logística

**Ideas clave**

+ La probabilidad: Es una medida que señala que tan posible es que ocurra un fenómeno o evento. Oscila entre 0 y 1. Cuanto más cerca de 0 menos probabilidad, y cuanto más cerca del 1 indica más probabilidad. Ejemplo: la probabilidad de ganar en un partido de futbol.

+ Odds: Es la probabilidad de que suceda un evento dividido por la probabilidad de que no suceda. Oscilan entre 0 e infinito y se pueden calcular para la ocurrencia del evento como para la no ocurrencia del evento. Ejemplo: la probabilidad de ganar una apuesta en un partido de futbol es 1.5 veces más probable que perder

+ ODDs Ratio: Es la razón entre dos odds. Permite comparar los odds de un evento en dos grupos  Va de 0 a infinito. Los modelos de regresión logística están basados en probabilidades entre dos variables. Por esta razón, es útil conocer los ODDs ratio. Ejemplo: Ganar en una apuesta de un partido de futbol es 5 veces más probable que el ganar en una apuesta de voley

+ La regresión logística modela el comportamiento de la probabilidad del evento de interés. Es un tipo de análisis de regresión utilizado para predecir el resultado de una variable categórica ( dependiente) en función de las variables predictoras (independientes). Es útil para modelar la probabilidad de que ocurra un evento en función del efecto de un conjunto de variables.

+ La idea es que la regresión logística aproxime la probabilidad de obtener "0" (no ocurre cierto suceso) o "1" (ocurre el suceso) con el valor de la variable explicativa x.
 

```{r}
iop=import("https://github.com/gabrielramost/Lab_estadistica_2/blob/main/Sesi%C3%B3n%204/IOP_0717_01_D.sav?raw=true")
data = subset(iop, select = c(NRO, P17, P3B, P8, P14, P30, P19, P92, EDAD, SEXO))
```


**Configuración de las variables:**

**Dependiente: ¿La democracia puede funcionar sin el Congreso?**

```{r}
library(car)
data$no_cong = recode(data$P17, "2 = 1 ; 1 = 0 ; 8:9 = NA")
data$no_cong = as.factor(data$no_cong)
plot(data$no_cong)
```

**Variables independientes**

Confianza en el congreso:

```{r}
data$conf_con = factor(ifelse(data$P3B == 1,1,
                              ifelse(data$P3B == 2,1,
                                     ifelse(data$P3B == 3,2,
                                            ifelse(data$P3B == 4,2,0)))))
data$conf_con[data$conf_con == 0] <- NA 
data$conf_con = factor(data$conf_con, levels = c(1:2), labels = c("Trust","NoTrust"))
```

Situación económica

```{r}
data$sit_eco = ifelse(data$P8 == 1,1,
                      ifelse(data$P8 == 2,1,
                             ifelse(data$P8 == 3,2,
                                    ifelse(data$P8 == 4,2,
                                           ifelse(data$P8 == 5,2,0)))))
data$sit_eco[data$sit_eco == 0] <- NA 
data$sit_eco = factor(data$sit_eco, levels = c(1:2), labels = c("Better","Worst"))
```

Autoidentificación ideológica

```{r}
data$ideologia = recode(data$P14, "88:99 = NA")
```

Satisfacción con la democracia

```{r}
data$demo = ifelse(data$P19 == 1,1,
                   ifelse(data$P19 == 2,1,
                          ifelse(data$P19 == 3,2,
                                 ifelse(data$P19 == 4,2,0))))
data$demo[data$demo == 0] <- NA 
data$demo = factor(data$demo, levels = c(1:2), labels = c("Yes","No"))
```

Edad

```{r}
data$EDAD=as.numeric(data$EDAD)
```

Sexo

```{r}
data$sexo = as.factor(data$SEXO)
levels(data$sexo) = c("Hombre", "Mujer")
```


Realizamos el modelo de regresión logística ¿Qué factores determinan la creencia de que la democracia puede funcionar sin el Congreso de la República? Vamos a modelar esa probabilidad

Ya estamos listos para realizar nuestros modelos

```{r}
data = na.omit(data)
```


**Calculo mi modelo:**

Modelando la probabilidad de considerar que la democracia puede funcionar sin congreso:

```{r}
set.seed(2019)
modelo = glm(no_cong ~ EDAD, family = binomial, data = data)
modelor = glm(no_cong ~ EDAD + conf_con, family = binomial, data = data)
modelog = glm(no_cong ~ EDAD + conf_con + demo, family = binomial, data = data)
modelo1 = glm(no_cong ~ EDAD + conf_con + demo + sit_eco, family = binomial, data = data)
stargazer(modelo, modelor,modelog,modelo1, type = "text")
```

Cuando queremos comparar modelos vemos el Akaike (AIC), se considera que un modelo es mejor si tiene un AIC menor a los demás.

Los coeficientes, están modelando al logaritmo del odds de ser voluntario.

¿Cuál es el efecto de las X sobre el Odds de la dependiente?

```{r}
#Edad
exp(coef(modelo1)["EDAD"])

#Confianza en el congreso
exp(coef(modelo1)["conf_conNoTrust"])

#Democracia
exp(coef(modelo1)["demoNo"])
```

Calculamos efectos marginales (lenguaje probabilístico)

```{r}
library(margins)
model = margins(modelo1) #visualicemos esto en la consola
margins=summary(model)#Otra forma, aqui vemos los AME. visualicemos esto en la consola
margins$ef = margins$AME*100
margins
```

+ En promedio, por cada nivel de edad, la probabilidad de creer que la democracia puede funcionar sin el Congreso de la República, disminuye en 0.2%

+ En promedio, por cada nivel de ideología (derecha), la probabilidad de creer que la democracia puede funcionar sin el Congreso de la República, disminuye en 2%

+ En promedio, la ausencia de confianza en el Congreso aumenta la probabilidad de creer que la democracia puede funcionar sin Congreso en 9%

+ Estar insatisfecho con la democracia aumenta la probabilidad de creer que la democracia puede funcionar sin Congreso en 10%

### Graficamos

```{r}
margins$low_f = 100*margins$lower
margins$upp_f = 100*margins$upper
```

```{r}
library(ggplot2)
base= ggplot(margins,aes(x=factor, y=ef)) + geom_point() +  geom_errorbar(aes(ymin=low_f, ymax=upp_f)) +
        geom_point(shape=21, size=3, fill="white") +
          ylim(-10,20)
base
```

Valores concretos:

La probabilidad de creer que la democracia puede funcionar sin Congreso, teniendo 18 años, desconfiando del Congreso, estando insatisfecho con la democracia y creyendo que la situación económica está peor: 51%

```{r}
ToInput1 <- data.frame(conf_con=c("NoTrust"),demo=c("No"),sit_eco=c("Worst"), 
                      EDAD=18)
predict(object = modelo1, newdata = ToInput1, type = "response")
```

Para la misma edad, pero con mejores percepciones:33%

```{r}
ToInput1 <- data.frame(conf_con=c("Trust"),demo=c("Yes"),sit_eco=c("Better"), 
                      EDAD=18)
predict(object = modelo1, newdata = ToInput1, type = "response")
```



### c. Regresión Cox

El objetivo de la regresión Cox es evaluar los impactos de diferentes variables sobre la "sobrevivencia". Es decir, nos ayuda a saber si ciertos factores influecian la tasa de ocurrencia de un evento en específico en un lapso de tiempo.

```{r}
library(survival)
library(survminer)
```

Vamos a trabajar con una base de datos de personas con cancer al pulmón:

```{r}
head(lung)
```

Estas son las variables:

inst: Institution code
time: Survival time in days
status: censoring status 1=censored, 2=dead
age: Age in years
sex: Male=1 Female=2
ph.ecog: ECOG performance score (0=good 5=dead)
ph.karno: Karnofsky performance score (bad=0-good=100) rated by physician
pat.karno: Karnofsky performance score as rated by patient
meal.cal: Calories consumed at meals
wt.loss: Weight loss in last six months

Vamos a ver algunos descriptivos del tiempo de sobrevivencia:

```{r}
summary(lung$time)
```

Ahora de la ocurrencia del evento:

```{r}
#Recodificamos para que 0 sea la ocurrencia:
lung$status1 = ifelse(lung$status == 2,1,0)
table(lung$status1)
```


Empezamos con el análisis:

```{r}
lung$survival=with(lung,Surv(time = time,
                             event =  status1))
```

```{r}
library(ggplot2)
library(ggfortify)

KM.generico = survfit(survival ~ 1, data = lung)

ejeX='DAYS\n Curva cae cuando ocurre un fallecimiento'
ejeY='Probabilidad \n(Sobrevivir)'
titulo="Curva de Sobrevivencia"
autoplot(KM.generico,xlab=ejeX,ylab=ejeY, main = titulo,conf.int = F)
```

Lo que indica el gráfico es que la probabilidad de sobrevivir al cancer en el día 0 es del 100% (todas las personas del estudio están vivas). Esta diminuye conforme avanzan los días. Pasado el día número 500, la probabilidad de sobrevivir es menor al 25%.

Ahora probemos una hipótesis: los hombres tienen una menor probabilidad de sobrevivir.

```{r}
KM_H1=formula(survival ~ sex)

KM.sex = survfit(KM_H1, data = lung)

###
ejeX='DAYS\n Curva cae cuando ocurre un fallecimiento'
ejeY='Probabilidad \n(Sobrevivir)'
titulo="Curva de Sobrevivencia"

autoplot(KM.sex,xlab=ejeX,ylab=ejeY, 
         main = titulo,conf.int = F)  + 
        labs(colour = "Impacto del género") + 
         scale_color_discrete(labels = c("Hombre", "Mujer"))
```

Efectivamente, parece que la mejor no pinta tan bien para los hombres. Veamos los intervalos de confianza:

```{r}
LogRank=survdiff(KM_H1, data = lung)
LogRank$pvalue
```

```{r}
autoplot(KM.sex,xlab=ejeX,ylab=ejeY, 
         main = titulo,conf.int = T)+ 
        labs(colour = "Impacto del género") + 
         scale_color_discrete(labels = c("Hombre", "Mujer"))
```

Probemos ahora otra hipótesis: más joven es la persona, sus probabilidad de sobrevivir serán mayores. Para ver cómo juegan ambas variables a la vez, hay que evaluarlo con una regresión:

```{r}
COX_H1= formula(survival~factor(sex)+age)
rcox1 <- coxph(COX_H1,data=lung)
summary(rcox1)
```

Vemos que el género tiene un impacto negativo sobre la probabilidad de fallecimiento. Es decir, el ser mujer (2) disminuye la probabilidad de ocurrencia del evento. Esto es estadísticamente significativo, mientras que la edad no muestra impactos. Pero, en tanto esta es una combinación lineal, no se pueden interpretar directamente:

```{r}
(sex=abs(1-exp(coef(rcox1)[1])))
```

Esto ya se puede interpretar: ser mujer está asociado con un mejor pronóstico, reduciendo las probabilidades de ocurrencia del evento en 40%.



